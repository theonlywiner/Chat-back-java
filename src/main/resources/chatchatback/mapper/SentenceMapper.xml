<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="chatchatback.mapper.SentenceMapper">
    <insert id="insertBachAIQuestions" parameterType="java.util.List">
        INSERT INTO ai_exercise_questions (source_text, content, answer, analysis, positions, difficulty, technique_id)
        VALUES
        <foreach collection="exerciseQuestionsList" item="item" separator=",">
            (
                #{item.sourceText},
                #{item.content},
                #{item.answer},
                #{item.analysis},
                #{item.positions, typeHandler=com.baomidou.mybatisplus.extension.handlers.JacksonTypeHandler},
                #{item.difficulty},
                #{id}
            )
        </foreach>
    </insert>

    <resultMap id="SentenceQuestionVOMap" type="chatchatback.pojo.vo.SentenceQuestionVO">
        <id property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="difficulty" column="difficulty"/>
        <result property="description" column="description"/>
        <result property="keywords" column="keywords"/>
        <result property="steps" column="steps" typeHandler="com.baomidou.mybatisplus.extension.handlers.JacksonTypeHandler"/>
        <result property="pitfalls" column="pitfalls"/>
        <collection property="exerciseQuestionsList" ofType="chatchatback.pojo.entity.ExerciseQuestions">
            <id property="id" column="question_id"/>
            <result property="sourceText" column="source_text"/>
            <result property="content" column="content"/>
            <result property="answer" column="answer"/>
            <result property="analysis" column="analysis"/>
            <result property="positions" column="positions" typeHandler="com.baomidou.mybatisplus.extension.handlers.JacksonTypeHandler"/>
            <result property="difficulty" column="q_difficulty"/>
        </collection>
    </resultMap>

    <select id="getSkillsQuestions" resultMap="SentenceQuestionVOMap">
        SELECT
            st.id,
            st.name,
            st.difficulty,
            st.description,
            st.keywords,
            st.steps,
            st.pitfalls,
            eq.id AS question_id,
            eq.source_text,
            eq.content,
            eq.answer,
            eq.analysis,
            eq.positions,
            eq.difficulty AS q_difficulty
        FROM segmentation_techniques st
                 LEFT JOIN technique_relations tr ON st.id = tr.technique_id
                 LEFT JOIN exercise_questions eq ON tr.question_id = eq.id
        WHERE st.id = #{id}
    </select>

    <resultMap id="SegmentationTechniquesMap" type="chatchatback.pojo.entity.SegmentationTechniques">
        <id property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="difficulty" column="difficulty"/>
        <result property="description" column="description"/>
        <result property="keywords" column="keywords"/>
        <result property="steps" column="steps" typeHandler="com.baomidou.mybatisplus.extension.handlers.JacksonTypeHandler"/>
        <result property="pitfalls" column="pitfalls"/>
    </resultMap>
    <select id="getSkills" resultMap="SegmentationTechniquesMap">
        SELECT id, name, difficulty, description, keywords, steps, pitfalls FROM segmentation_techniques
    </select>
</mapper>